name: matrix_test

on: workflow_dispatch

env:
  GH_TOKEN: ${{ secrets.GH_VARIABLE_PAT }}

jobs:
  matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        value: [1, 2, 3]
    steps:
      - name: 'Step (matrix.value: ${{ matrix.value }})'
        env:
          VALUE: '${{ matrix.value }}'
        run: |
          [[ $VALUE == '1' ]]

      - name: Set failure status for ${{ matrix.value }}
        if: failure()
        env:
          KEY: ${{ format('{0}__{1}_{2}_{3}', github.job, github.run_id, github.run_number, github.run_attempt) }}
          VALUE: ${{ matrix.value }}
        run: |
          gh --repo '${{ github.repository }}' variable set "$KEY" --body "$VALUE"

  skip:
    if: false
    runs-on: ubuntu-latest
    steps:
      - name: Skip
        run: exit 0

  pass:
    runs-on: ubuntu-latest
    steps:
      - name: Pass
        run: exit 0

  fail:
    runs-on: ubuntu-latest
    steps:
      - name: Fail
        run: exit 1

  status:
    needs: [matrix, skip, pass, fail]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Dump needs JSON
        run: |
          {
            echo '## `needs` JSON'
            echo '```json'
            echo '${{ toJson(needs) }}'
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Dump variables
        run: |
          {
            echo '## Variables'
            gh --repo '${{ github.repository }}' variable list
          } >> "$GITHUB_STEP_SUMMARY"
