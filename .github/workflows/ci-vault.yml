name: vault

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    services:
      vault:
        image: hashicorp/vault:latest
        ports:
          - 8200:8200
        env:
          VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
          VAULT_DEV_ROOT_TOKEN_ID: my-root-token
        options: --cap-add IPC_LOCK

    env:
      VAULT_ADDR: http://0.0.0.0:8200
      VAULT_DEV_ROOT_TOKEN_ID: my-root-token

    steps:
      - name: Wait for Vault to be ready
        run: |
          until curl -s "$VAULT_ADDR/v1/sys/health" | grep -q '"sealed":false'; do
            echo "Waiting for Vault to unseal..."
            sleep 5
          done

      - name: Login
        run: vault login "$VAULT_DEV_ROOT_TOKEN_ID"

      - name: Set
        run: vault kv put docker/config image=alpine:latest

      - name: Get
        run: vault kv get docker/config
