name: vault

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    services:
      vault:
        image: hashicorp/vault:latest
        ports:
          - 8200:8200
        env:
          VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
          VAULT_DEV_ROOT_TOKEN_ID: my-root-token
        options: --cap-add IPC_LOCK

    env:
      VAULT_ADDR: http://0.0.0.0:8200
      VAULT_DEV_ROOT_TOKEN_ID: my-root-token

    steps:
      - name: Wait for Vault to be ready
        run: |
          until curl -s "$VAULT_ADDR/v1/sys/health" | grep -q '"sealed":false'; do
            echo "Waiting for Vault to unseal..."
            sleep 5
          done

      - name: Install vault CLI
        run: |
          # https://developer.hashicorp.com/vault/install#linux
          wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(grep -oP '(?<=UBUNTU_CODENAME=).*' /etc/os-release || lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
          sudo apt update && sudo apt install -y vault

      - name: Login
        run: vault login "$VAULT_DEV_ROOT_TOKEN_ID"

      - name: Set
        run: vault kv put docker/config image=alpine:latest

      - name: Get
        run: vault kv get docker/config
